# =============================================================================
# Top-Down Racer 01 — Master Configuration
# =============================================================================
# All tunable game parameters live here. No magic numbers in code.
# Every agent reads from this file. Change values here to tweak the game.
# =============================================================================

# -----------------------------------------------------------------------------
# Screen / Window
# -----------------------------------------------------------------------------
screen:
  width: 1280          # Window width in pixels
  height: 720          # Window height in pixels
  fps: 60              # Target frames per second
  title: "Top-Down Racer 01"  # Window title bar text

# -----------------------------------------------------------------------------
# Car Physics
# -----------------------------------------------------------------------------
car:
  max_speed: 400         # Maximum forward speed in pixels/second
  acceleration: 300      # Forward acceleration in pixels/second^2
  brake_force: 500       # Braking deceleration in pixels/second^2 (stronger than accel for responsive braking)
  reverse_max_speed: 150 # Maximum reverse speed in pixels/second (slower than forward to prevent exploit)
  steering_speed: 2.5    # Steering rate in radians/second (~143 deg/s)
  drift_grip_multiplier: 0.3  # Grip multiplier when drifting (0.0 = ice, 1.0 = full grip) — 0.3 makes rear end slide out
  normal_grip: 1.0       # Baseline grip multiplier during normal driving
  mass: 1.0              # Normalized car mass — used as a multiplier in physics calculations
  width: 30              # Car body width in pixels (short axis)
  length: 50             # Car body length in pixels (long axis, front-to-back)

# -----------------------------------------------------------------------------
# Damage System
# -----------------------------------------------------------------------------
damage:
  wall_damage_multiplier: 0.1  # Damage = impact_speed * this value. At max_speed (400), one hit = 40 damage = 5 hits to die. Punishing but survivable.
  min_damage_speed: 100        # Minimum impact speed (pixels/sec) to take damage. Scrapes and grazes are free.
  max_health: 200              # Starting and maximum health points — doubled for more forgiving gameplay

# -----------------------------------------------------------------------------
# Track Layout
# -----------------------------------------------------------------------------
# The track is defined by centerline points forming a closed loop.
# The Track class offsets these by +/- track_width/2 to create inner/outer walls.
#
# Design: Clockwise circuit spanning ~3000x3000 pixels, centered around (1500, 1500).
# Features:
#   - Long bottom straight (start/finish) for top-speed runs
#   - Sweeping right turn into the east side
#   - Fast curve at the top-right
#   - S-curve through the north section
#   - Sharp hairpin at the top-left (rewards good drift technique)
#   - Chicane descent along the west side
#   - Return to start/finish straight
# -----------------------------------------------------------------------------
track:
  track_width: 120  # Default road width in pixels (used as fallback if point_widths not set)

  # Per-point road widths — one value per centerline point (must match centerline_points length).
  # Tight technical sections are wider to give room for braking and drifting.
  # Straights stay narrow to feel fast and focused.
  # Sections:           straight  sweeper  e-str  top-curve    S-curve (x5)    hairpin (x4)   chicane (x4)  approach
  point_widths: [170, 170, 150,   150, 150, 140,   130, 130,   150, 160, 170,  190, 200, 200, 200, 190,     240, 270, 280, 260,   185, 185, 170, 140]

  # Centerline points [x, y] defining the track shape as a closed loop.
  # Points are ordered clockwise. The last point connects back to the first.
  # Coordinate space: roughly (200, 200) to (2900, 2800) — spanning ~2700x2600 pixels.
  centerline_points:
    # === START/FINISH STRAIGHT (bottom, going right) ===
    - [400, 400]       # 0  - Start/finish line (spawn near here)
    - [900, 400]       # 1  - Mid straight
    - [1400, 400]      # 2  - End of long straight

    # === SWEEPING RIGHT TURN (bottom-right, curving up) ===
    - [1800, 450]      # 3  - Start of right sweeper
    - [2100, 600]      # 4  - Mid sweeper
    - [2300, 850]      # 5  - Exit sweeper, heading north

    # === EAST SIDE STRAIGHT (going north) ===
    - [2400, 1150]     # 6  - Short straight heading north
    - [2450, 1500]     # 7  - Checkpoint on east side

    # === FAST TOP-RIGHT CURVE ===
    - [2400, 1800]     # 8  - Entry to fast right curve
    - [2250, 2050]     # 9  - Apex of fast curve
    - [2000, 2200]     # 10 - Exit fast curve, heading west

    # === S-CURVE (north section, technical) ===
    - [1700, 2350]     # 11 - S-curve entry (turning left)
    - [1400, 2500]     # 12 - S-curve midpoint (apex 1)
    - [1150, 2350]     # 13 - S-curve transition (turning right)
    - [900, 2500]      # 14 - S-curve apex 2
    - [650, 2400]      # 15 - S-curve exit

    # === SHARP HAIRPIN (top-left) ===
    - [450, 2200]      # 16 - Hairpin approach (heading south-west)
    - [300, 2000]      # 17 - Hairpin entry (tight!)
    - [280, 1750]      # 18 - Hairpin apex — tightest point, ~180 degree turn
    - [350, 1500]      # 19 - Hairpin exit (now heading south)

    # === WEST SIDE CHICANE (descending south) ===
    - [500, 1300]      # 20 - Chicane entry — jink right
    - [350, 1100]      # 21 - Chicane midpoint — jink left
    - [500, 900]       # 22 - Chicane exit
    - [400, 650]       # 23 - Approach to start/finish

    # (Loop closes: point 23 connects back to point 0 at [400, 400])

  # Checkpoint indices — indices into centerline_points where lap checkpoints are placed.
  # Checkpoints are line segments across the track at these points.
  # The car must cross ALL checkpoints in order to complete a lap.
  # Spaced roughly evenly around the circuit (~every 5-6 points).
  checkpoint_indices:
    - 5    # After the sweeping right turn
    - 10   # After the fast top-right curve
    - 15   # After the S-curve
    - 20   # After the hairpin, entering the chicane
    - 0    # Start/finish line — MUST BE LAST (crossing this completes the lap)

  # Spawn offset: how many pixels forward from centerline[0] the car spawns.
  # Prevents the car from sitting on top of the start/finish checkpoint at reset.
  spawn_forward_offset: 200

  # Total laps to complete a race
  total_laps: 3

# -----------------------------------------------------------------------------
# Camera
# -----------------------------------------------------------------------------
camera:
  follow_speed: 0.1      # Lerp factor per frame (0.0 = static, 1.0 = instant). 0.1 = smooth trailing.
  zoom: 1.0              # Camera zoom level (1.0 = no zoom, <1 = zoomed out, >1 = zoomed in)
  lookahead_factor: 0.3  # How far ahead of the car the camera looks, as a fraction of velocity. Biases view toward direction of travel.

# -----------------------------------------------------------------------------
# Colors (RGB tuples, 0-255)
# -----------------------------------------------------------------------------
colors:
  background_color: [30, 30, 30]      # Dark gray — world background outside the track
  road_color: [60, 60, 60]            # Slightly lighter gray — the drivable road surface
  wall_color: [200, 200, 200]         # Light gray — track boundary walls (high contrast against road)
  car_color: [255, 50, 50]            # Bright red — the player car
  drift_trail_color: [100, 80, 50]    # Brownish — tire marks left during drift (like burnt rubber)
  hud_text_color: [255, 255, 255]     # White — HUD text (speed, lap, timer)
  health_high_color: [50, 200, 50]    # Green — health bar when health is high
  health_low_color: [200, 50, 50]     # Red — health bar when health is critically low

# -----------------------------------------------------------------------------
# Drift Trails
# -----------------------------------------------------------------------------
drift:
  trail_lifetime: 3.0    # How long drift trail marks last in seconds before disappearing
  trail_width: 4          # Width of drift trail lines in pixels
  trail_fade_rate: 0.3    # Opacity decrease per second (1.0 / 0.3 = ~3.3s to fully fade, aligns with lifetime)

# -----------------------------------------------------------------------------
# AI / Reinforcement Learning
# -----------------------------------------------------------------------------
# Reward weights and training parameters for the Gymnasium RL environment.
# All reward components are tuned so that:
#   - Clean fast lap ≈ +270 total reward
#   - Sloppy lap with wall hits ≈ +210
#   - Dying halfway ≈ +40 then -20
#   - Sitting still ≈ -18 per 30 seconds
# The ratios matter more than absolute values. Breadcrumb checkpoints are the
# PRIMARY learning signal — everything else is secondary shaping.
# -----------------------------------------------------------------------------
ai:
  # --- Policy ---
  policy: MlpPolicy                 # SB3 policy class name.

  # --- Observation space ---
  num_rays: 12                      # Number of ray-cast distance sensors for AI observations.
  ray_spread_degrees: 240           # Forward fan arc for ray casting (degrees).
  max_ray_distance: 400             # Maximum ray length in pixels.

  # --- Training checkpoints (breadcrumbs) ---
  # Placed every `training_checkpoint_spacing` pixels along the track centerline.
  # ~50 per lap at 150px spacing on this ~7200px circuit.
  training_checkpoint_spacing: 150  # Pixels between training breadcrumbs along the centerline
  training_checkpoint_radius: 40    # How close car must get to collect a breadcrumb (pixels).
  zigzag_spacing_multiplier: 0.5    # Tighter spacing in high-curvature sections (< 1.0 = more checkpoints).
  curvature_threshold: 0.3          # Radians; centerline segments above this are "tight".
  training_checkpoint_reward: 5.0   # Reward per breadcrumb collected. 50 * 5.0 = 250 per lap — the backbone of learning.

  # --- Lap completion ---
  lap_completion_bonus: 20.0        # Bonus on top of the final breadcrumb for completing a full lap.

  # --- Speed reward (continuous) ---
  # reward += (speed / max_speed) * speed_reward_scale per step.
  # Set to 0.0 for v6: replaced by forward progress reward to prevent wall-hugging exploit.
  speed_reward_scale: 0.0           # Disabled in v6 -- forward progress reward replaces this.

  # --- Forward progress reward (v6) ---
  # Rewards movement along the track centerline. Positive delta = forward progress,
  # negative delta = backward movement. Kills wall-hugging exploit because pinned
  # cars make zero centerline progress regardless of wheel speed.
  # With 24 centerline points, one full lap = 24.0 progress units.
  # At ~0.02 progress/step cruising, reward/step ~ 0.04. Over ~1200 steps per lap: ~48.
  forward_progress_reward_scale: 2.0   # Reward per unit of centerline progress (forward).
  backward_progress_penalty_scale: 0.5 # Penalty multiplier for backward centerline movement.

  # --- Wall hit penalty ---
  # reward -= wall_damage * wall_damage_penalty_scale per collision step.
  # A 300 px/s impact deals (300-100)*0.1 = 20 damage → penalty = 20 * 0.5 = -10.
  # One heavy hit ≈ losing ~3 breadcrumbs worth of reward.
  wall_damage_penalty_scale: 0.8    # Proportional to actual damage taken. Was 2.0 (v3) -- too lethal, episodes ended before learning.

  # --- Death penalty ---
  death_penalty: 20.0               # Large negative for dying. Episode-terminal.

  # --- Time penalty (per step) ---
  # Prevents the agent from sitting still. At 60fps over 30s: 0.01 * 1800 = -18.
  time_penalty: 0.01                # Small constant subtracted every step.

  # --- Smooth steering bonus ---
  # Encourages smooth driving. Fires when steering change between steps < threshold.
  smooth_steering_bonus: 0.01       # Small reward for not jerking the wheel.
  smooth_steering_threshold: 0.1    # Max |curr_steering - prev_steering| to qualify.

  # --- Stuck detection ---
  # If the car is stuck (very low speed for too long), apply death-level penalty.
  # The environment wrapper handles detecting "stuck" — rewards.py just uses the flag.
  stuck_speed_threshold: 10.0       # Speed below this counts as "stuck" (pixels/sec).
  stuck_timeout: 2.0                # Seconds at low speed before is_stuck fires.

  # --- Spawn protection ---
  spawn_grace_steps: 30             # Steps after reset where checkpoint collection is disabled.
  min_checkpoint_speed: 5.0         # Minimum forward speed (px/s) to collect a checkpoint. Prevents reverse-crossing credit.

  # --- Episode limits ---
  max_episode_steps: 6000           # Hard cutoff (~100 seconds at 60fps). Prevents infinite episodes.

  # --- Training hyperparameters (PPO via Stable-Baselines3) ---
  num_parallel_envs: 8              # SubprocVecEnv workers.
  total_timesteps: 500000           # Default training budget.
  learning_rate: 0.0003             # Adam optimizer LR.
  n_steps: 2048                     # Rollout buffer length per env.
  batch_size: 64                    # Minibatch size for PPO updates.
  n_epochs: 10                      # PPO epochs per rollout.
  gamma: 0.99                       # Discount factor.
  gae_lambda: 0.95                  # GAE lambda.
  clip_range: 0.2                   # PPO clipping range.
  ent_coef: 0.01                    # Entropy bonus coefficient. Default SB3 is 0.0; 0.01 keeps exploration alive longer.
