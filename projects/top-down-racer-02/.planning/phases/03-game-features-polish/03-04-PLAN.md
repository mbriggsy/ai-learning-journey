---
phase: 03-game-features-polish
plan: 04
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - src/tracks/track02.ts
  - src/tracks/track03.ts
autonomous: true
requirements: [TRK-02]

must_haves:
  truths:
    - "Track 02 is a fast/flowing circuit: wide, sweeping curves, high-speed sections — tests top-end control"
    - "Track 03 is a tight/technical circuit: narrow, lots of braking zones, hairpins — tests precision"
    - "Both tracks use variable width per section (narrow chicanes opening to wide sweepers)"
    - "Both tracks use the same TrackControlPoint format as track01.ts"
    - "Both tracks produce valid tracks when passed to buildTrack() with 30 checkpoints"
    - "Each track has a distinct character — driving all three feels different"
  artifacts:
    - path: "src/tracks/track02.ts"
      provides: "TRACK_02_CONTROL_POINTS — fast/flowing track data"
    - path: "src/tracks/track03.ts"
      provides: "TRACK_03_CONTROL_POINTS — tight/technical track data"
  key_links:
    - from: "src/tracks/track02.ts"
      to: "src/engine/types.ts"
      via: "exports TrackControlPoint[] array"
    - from: "src/tracks/track03.ts"
      to: "src/engine/types.ts"
      via: "exports TrackControlPoint[] array"
---

<objective>
Design two additional tracks with distinct driving characters, giving the player three different experiences and the AI three different optimization challenges in Phase 5.

Track 02 — "Speedway" (fast/flowing): Wide, sweeping curves, long straights, high-speed commitment corners. Tests maintaining speed through gentle arcs and top-end control.

Track 03 — "Gauntlet" (tight/technical): Narrow, tight hairpins, heavy braking zones, chicanes. Tests precision braking, tight turn-in, and low-speed car control.

Output: Two track data files (track02.ts, track03.ts) with TrackControlPoint arrays that produce valid tracks via buildTrack().
</objective>

<context>
@.planning/03-CONTEXT.md
@.planning/ROADMAP.md

<interfaces>
From src/engine/types.ts:
```typescript
export interface TrackControlPoint {
  position: Vec2;
  width: number;
}
export interface Vec2 { x: number; y: number; }
```

From src/tracks/track01.ts (reference format):
```typescript
import type { TrackControlPoint } from '../engine/types';

const W = 12; // Default width

export const TRACK_01_CONTROL_POINTS: TrackControlPoint[] = [
  { position: { x: 0, y: 0 }, width: W },
  // ... 13 more control points
];
```

From src/engine/track.ts:
```typescript
export function buildTrack(
  controlPoints: TrackControlPoint[],
  checkpointCount: number,
): TrackState { ... }
```

Design decisions (CONTEXT.md — locked):
- Track 02: Fast/flowing — wide, sweeping curves, high-speed
- Track 03: Tight/technical — narrow, lots of braking zones, hairpins
- Variable width per section
- Spline-based, closed loops
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Track 02 — "Speedway" (fast/flowing)</name>
  <files>
    src/tracks/track02.ts
  </files>
  <action>
Create `src/tracks/track02.ts`. Design a fast, flowing circuit.

Character: Wide, sweeping curves that reward maintaining speed. Long straights with gentle arcs. One or two faster-entry corners that require commitment. Width is generally wider than Track 01 to allow line choice at high speed, with slight narrowing at key corners.

Guidelines for the spline control points:
- ~16-18 control points for a flowing layout (more points = smoother curves)
- Default width ~14-16 units (wider than Track 01's 12)
- Narrow to ~11-12 at the two tightest corners (still wider than Track 01's tightest)
- Include 2-3 long sweeping arcs (large radius curves spanning multiple control points)
- Include 1-2 short straights between sweepers
- Total perimeter should be similar to Track 01 (800-1200 units)
- Closed loop that returns to start

```typescript
import type { TrackControlPoint } from '../engine/types';

export const TRACK_02_CONTROL_POINTS: TrackControlPoint[] = [
  // Start/finish straight — wide
  { position: { x: 0, y: 0 }, width: 15 },
  { position: { x: 80, y: 0 }, width: 15 },

  // Sweeping right curve (gentle, wide)
  { position: { x: 140, y: 30 }, width: 16 },
  { position: { x: 170, y: 80 }, width: 15 },
  { position: { x: 160, y: 140 }, width: 14 },

  // Back straight with gentle left bend
  { position: { x: 120, y: 190 }, width: 15 },
  { position: { x: 60, y: 220 }, width: 16 },

  // Fast left kink (commitment corner — narrows slightly)
  { position: { x: -10, y: 230 }, width: 13 },
  { position: { x: -60, y: 210 }, width: 14 },

  // Long sweeping right returning north
  { position: { x: -100, y: 170 }, width: 15 },
  { position: { x: -120, y: 110 }, width: 16 },
  { position: { x: -110, y: 50 }, width: 15 },

  // Medium-speed left leading to final straight
  { position: { x: -80, y: 10 }, width: 13 },
  { position: { x: -50, y: -20 }, width: 14 },

  // Final approach back to start
  { position: { x: -20, y: -15 }, width: 15 },
];
```

Verify the track builds without error by confirming it has at least 3 control points and forms a reasonable closed loop (first and last points should be near the start/finish area, with the spline naturally closing).
  </action>
  <verify>
    <automated>cd "C:/Users/brigg/ai-learning-journey/projects/top-down-racer-02" && pnpm exec tsc --noEmit 2>&1 | grep "track02" | head -5 || echo "No track02 errors"</automated>
  </verify>
  <done>
    src/tracks/track02.ts exports TRACK_02_CONTROL_POINTS.
    Track is fast/flowing with sweeping curves and variable width.
    TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Track 03 — "Gauntlet" (tight/technical)</name>
  <files>
    src/tracks/track03.ts
  </files>
  <action>
Create `src/tracks/track03.ts`. Design a tight, technical circuit.

Character: Narrow, lots of 90-degree and hairpin turns, heavy braking zones, chicanes. Rewards precision over speed. Width is generally narrower, with occasional wider sections to reward good exits.

Guidelines:
- ~18-22 control points (more points for tighter geometry)
- Default width ~9-10 units (narrower than Track 01's 12)
- Opens to ~12-13 at corner exits (reward for good line)
- Narrows to ~8 at chicane entries
- Include 2-3 hairpins (tight U-turns)
- Include 1 chicane section (quick left-right)
- Short straights only (50-70 units max)
- Total perimeter smaller than Track 01 (600-800 units — shorter but technical)

```typescript
import type { TrackControlPoint } from '../engine/types';

export const TRACK_03_CONTROL_POINTS: TrackControlPoint[] = [
  // Start/finish — medium width
  { position: { x: 0, y: 0 }, width: 10 },
  { position: { x: 60, y: 0 }, width: 10 },

  // Hard right (90-degree, narrows on entry)
  { position: { x: 90, y: 10 }, width: 9 },
  { position: { x: 105, y: 40 }, width: 10 },

  // Short straight then hairpin left
  { position: { x: 105, y: 90 }, width: 10 },
  { position: { x: 90, y: 120 }, width: 8 },
  { position: { x: 60, y: 130 }, width: 9 },

  // Chicane (quick left-right)
  { position: { x: 30, y: 115 }, width: 8 },
  { position: { x: 15, y: 90 }, width: 8 },
  { position: { x: 5, y: 65 }, width: 9 },

  // Hard right hairpin (tightest corner)
  { position: { x: -15, y: 50 }, width: 8 },
  { position: { x: -25, y: 25 }, width: 9 },

  // Short acceleration zone (opens up)
  { position: { x: -15, y: -10 }, width: 12 },

  // Tight left into braking zone
  { position: { x: -45, y: -35 }, width: 9 },
  { position: { x: -75, y: -25 }, width: 9 },

  // Exit hairpin left back toward start
  { position: { x: -80, y: 5 }, width: 10 },
  { position: { x: -60, y: 20 }, width: 10 },

  // Final approach (opens slightly for exit speed)
  { position: { x: -30, y: 15 }, width: 11 },
];
```
  </action>
  <verify>
    <automated>cd "C:/Users/brigg/ai-learning-journey/projects/top-down-racer-02" && pnpm exec tsc --noEmit 2>&1 | grep "track03" | head -5 || echo "No track03 errors"</automated>
  </verify>
  <done>
    src/tracks/track03.ts exports TRACK_03_CONTROL_POINTS.
    Track is tight/technical with hairpins, chicane, and variable width.
    TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify both tracks build correctly</name>
  <files>
    src/tracks/track02.ts
    src/tracks/track03.ts
  </files>
  <action>
Write a quick verification: create a small test or inline script that calls `buildTrack()` with each new track's control points and confirms no errors. This can be done via a Vitest test or a simple inline check.

If Vitest tests already exist for track building, add the new tracks to them. Otherwise, create a minimal test:

```typescript
// src/tracks/__tests__/tracks.test.ts
import { describe, it, expect } from 'vitest';
import { buildTrack } from '../../engine/track';
import { TRACK_01_CONTROL_POINTS } from '../track01';
import { TRACK_02_CONTROL_POINTS } from '../track02';
import { TRACK_03_CONTROL_POINTS } from '../track03';

describe('Track data', () => {
  it.each([
    ['Track 01', TRACK_01_CONTROL_POINTS],
    ['Track 02', TRACK_02_CONTROL_POINTS],
    ['Track 03', TRACK_03_CONTROL_POINTS],
  ])('%s builds without errors', (_name, points) => {
    const track = buildTrack(points, 30);
    expect(track.checkpoints.length).toBe(30);
    expect(track.innerBoundary.length).toBeGreaterThan(0);
    expect(track.outerBoundary.length).toBeGreaterThan(0);
    expect(track.totalLength).toBeGreaterThan(300);
  });
});
```
  </action>
  <verify>
    <automated>cd "C:/Users/brigg/ai-learning-journey/projects/top-down-racer-02" && pnpm exec vitest run --reporter=verbose 2>&1 | tail -20</automated>
  </verify>
  <done>
    Both tracks build without errors via buildTrack().
    Each produces 30 checkpoints, valid boundaries, and reasonable total length.
    Tests pass.
  </done>
</task>

</tasks>

<verification>
1. `pnpm exec tsc --noEmit` passes with 0 errors
2. `pnpm exec vitest run` — track tests pass for all 3 tracks
3. Track 02 has wider default width (14-16) with gentle curves
4. Track 03 has narrower default width (8-10) with tight corners
5. Both use variable width per section
</verification>

<success_criteria>
- TRK-02: 2 additional tracks with different character (3 total)
  - Track 02: fast/flowing — wide, sweeping curves
  - Track 03: tight/technical — narrow, hairpins, chicanes
  - Both use variable width per section
</success_criteria>

<output>
After completion, create `.planning/phases/03-game-features-polish/03-04-SUMMARY.md`
</output>

<research_insights deepened="2026-02-28" agents="pattern-recognition, repo-research-analyst, code-simplicity-reviewer">

## Enhancement Summary

**Key improvements:** 1 CRITICAL width correction, 2 minor refinements.

### RI-01 (CRITICAL): Width values are HALF-WIDTH — plan values are far too narrow
**Source:** Pattern recognition specialist, repo research analyst
The `width` field in `TrackControlPoint` is a **half-width** (confirmed by `track.ts` line 50: "Array of centerline control points with half-widths" and `track01.ts` comment: "half-width — generous for tuning"). Track 01 uses `W = 25` (half-width), meaning the full track width is **50 units**.

The plan's Track 02 uses widths of 13-16 (full width 26-32) and Track 03 uses widths of 8-12 (full width 16-24). These are **drastically narrower** than Track 01's 50-unit full width.

**Corrected width guidelines:**
| Track | Character | Plan half-width | Corrected half-width | Full width |
|-------|-----------|-----------------|---------------------|------------|
| Track 01 | Mixed | 25 (uniform) | 25 (existing) | 50 |
| Track 02 | Fast/flowing | 13-16 ❌ | 28-32 | 56-64 |
| Track 03 | Tight/technical | 8-12 ❌ | 18-22 | 36-44 |

Track 02 should be **wider** than Track 01 (reward high-speed line choice), narrowing to ~24 at commitment corners. Track 03 should be **narrower** than Track 01 (punish imprecision), opening to ~24 at corner exits.

**This must be fixed in the control point arrays before implementation.**

### RI-02: Use the same test pattern as existing engine tests
**Source:** Repo research analyst
Existing tests in `tests/engine/` use explicit imports (`import { describe, it, expect } from 'vitest'`), not globals. The test file should live at `tests/engine/tracks.test.ts` (not `src/tracks/__tests__/`) to match the existing directory convention.

### RI-03: Track geometry validation
Add assertions that track boundaries don't self-intersect. A simple check: ensure no inner boundary point is further from the centerline than the corresponding outer boundary point. This catches degenerate geometries from too-tight control point placement.

</research_insights>
